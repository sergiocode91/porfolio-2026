---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { ArrowLeft, Share2, Calendar, Clock } from '@lucide/astro';

import type { CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { Content } = await post.render();

const wordsPerMinute = 200;
const numberOfWords = post.body.split(/\s/g).length;
const minutes = Math.ceil(numberOfWords / wordsPerMinute);
const readingTime = `${minutes} min read`;

const allPosts = await getCollection('blog');
const relatedPosts = allPosts
  .filter(p => p.slug !== post.slug)
  .filter(p => p.data.category === post.data.category)
  .slice(0, 2);

if (relatedPosts.length < 2) {
    const otherPosts = allPosts
        .filter(p => p.slug !== post.slug && !relatedPosts.find(rp => rp.slug === p.slug))
        .slice(0, 2 - relatedPosts.length);
    relatedPosts.push(...otherPosts);
}
---

<Layout title={`${post.data.title} | Blog`}>
  <article class="pt-12 md:pt-20 pb-20">
    <div class="flex items-center justify-between mb-12">
      <a 
        href="/blog" 
        class="inline-flex items-center gap-2 text-[10px] uppercase tracking-[0.3em] font-bold text-neutral-500 dark:text-neutral-400 hover:text-black dark:hover:text-white transition-colors group"
      >
        <ArrowLeft class="w-4 h-4 group-hover:-translate-x-1 transition-transform" stroke-width={2.5} />
        BACK TO BLOG
      </a>
      
      <button 
        id="share-button"
        class="inline-flex items-center gap-2 p-2 rounded-full hover:bg-neutral-100 dark:hover:bg-white/5 text-neutral-500 dark:text-neutral-400 hover:text-black dark:hover:text-white transition-colors cursor-pointer group"
      >
        <Share2 class="w-5 h-5 group-hover:scale-110 transition-transform" stroke-width={1.5} />
      </button>
    </div>

    <header class="space-y-8 mb-16">
      <h1 class="text-4xl md:text-6xl font-serif italic text-neutral-900 dark:text-white leading-tight text-balance">
        {post.data.title}
      </h1>

      <div class="flex flex-wrap items-center gap-8 text-neutral-400 dark:text-neutral-500 font-sans text-xs uppercase tracking-widest font-bold">
        <div class="flex items-center gap-2">
          <Calendar class="w-4 h-4" stroke-width={1.5} />
          {post.data.date}
        </div>
        <div class="flex items-center gap-2">
          <Clock class="w-4 h-4" stroke-width={1.5} />
          {readingTime}
        </div>
      </div>
    </header>

    {post.data.heroImage && (
      <div class="relative aspect-video w-full overflow-hidden rounded-3xl bg-neutral-100 dark:bg-neutral-900 border border-neutral-200 dark:border-white/5 mb-20 shadow-xl dark:shadow-none">
        <img 
          src={post.data.heroImage} 
          alt={post.data.title}
          class="object-cover w-full h-full"
        />
      </div>
    )}

    <div class="prose dark:prose-invert prose-neutral max-w-none mb-32">
        <div class="space-y-8 text-neutral-600 dark:text-neutral-400 font-sans text-lg leading-relaxed">
            <Content />
        </div>
    </div>

    {relatedPosts.length > 0 && (
      <section class="border-t border-neutral-100 dark:border-white/10 pt-20">
        <h3 class="text-[10px] uppercase tracking-[0.3em] font-bold text-neutral-400 dark:text-neutral-500 mb-12">
          Continue Reading
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
          {relatedPosts.map((relatedPost) => (
            <a 
              href={`/blog/${relatedPost.slug}`}
              class="group block space-y-6"
            >
              <div class="relative aspect-video overflow-hidden rounded-2xl bg-neutral-100 dark:bg-neutral-900 border border-neutral-200 dark:border-white/5 shadow-sm dark:shadow-none">
                <img 
                  src={relatedPost.data.heroImage} 
                  alt={relatedPost.data.title}
                  class="object-cover w-full h-full group-hover:scale-105 transition-transform duration-700 ease-out"
                />
              </div>
              <div class="space-y-3">
                <h4 class="text-2xl font-serif italic text-neutral-900 dark:text-white group-hover:text-neutral-600 dark:group-hover:text-neutral-300 transition-colors leading-tight">
                  {relatedPost.data.title}
                </h4>
                <p class="text-xs text-neutral-400 dark:text-neutral-500 font-sans tabular-nums uppercase tracking-widest font-bold">
                  {relatedPost.data.date} Â· {relatedPost.data.category}
                </p>
              </div>
            </a>
          ))}
        </div>
      </section>
    )}
  </article>
</Layout>

<script>
    document.addEventListener('astro:page-load', () => {
        const shareButton = document.getElementById('share-button');
        
        if (shareButton) {
            shareButton.addEventListener('click', async () => {
                try {
                    await navigator.share({
                        title: document.title,
                        url: window.location.href
                    });
                } catch (err) {
                    try {
                        await navigator.clipboard.writeText(window.location.href);
                        const originalText = shareButton.innerHTML;
                        shareButton.innerHTML = '<span class="text-lime-500 font-bold">Copied!</span>';
                        setTimeout(() => {
                            shareButton.innerHTML = originalText;
                        }, 2000);
                    } catch (copyErr) {
                        console.error('Failed to share:', err);
                    }
                }
            });
        }
    });
</script>

<style is:global>
    .prose h2 {
        font-family: "Playfair Display", ui-serif, Georgia, serif;
        font-style: italic;
        color: #171717;
        font-size: 2rem;
        margin-top: 3.5rem;
        margin-bottom: 1.5rem;
    }
    .dark .prose h2 {
        color: white;
    }
    .prose p {
        margin-bottom: 1.5rem;
    }
    .prose blockquote {
        background: #f5f5f5;
        border: 1px solid #e5e5e5;
        padding: 2.5rem;
        border-radius: 1.5rem;
        font-family: "Playfair Display", ui-serif, Georgia, serif;
        font-style: italic;
        color: #404040;
        margin: 4rem 0;
    }
    .dark .prose blockquote {
        background: rgb(10 10 10);
        border: 1px solid rgba(255, 255, 255, 0.05);
        color: rgba(255, 255, 255, 0.7);
    }
    .prose ul {
        list-style-type: none;
        padding-left: 0;
        color: #404040;
        margin-bottom: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
    }
    .dark .prose ul {
        color: rgb(163 163 163);
    }
    .prose li {
        position: relative;
        padding-left: 1.5rem;
    }
    .prose li::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0.75rem;
        width: 0.5rem;
        height: 1px;
        background: #171717;
    }
    .dark .prose li::before {
        background: white;
    }
</style>
