---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { ArrowLeft, Share2, Calendar, Clock } from '@lucide/astro';

import type { CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { Content } = await post.render();

const wordsPerMinute = 200;
const numberOfWords = post.body.split(/\s/g).length;
const minutes = Math.ceil(numberOfWords / wordsPerMinute);
const readingTime = `${minutes} min read`;

const allPosts = await getCollection('blog');
const relatedPosts = allPosts
  .filter(p => p.slug !== post.slug)
  .filter(p => p.data.category === post.data.category)
  .slice(0, 2);

if (relatedPosts.length < 2) {
    const otherPosts = allPosts
        .filter(p => p.slug !== post.slug && !relatedPosts.find(rp => rp.slug === p.slug))
        .slice(0, 2 - relatedPosts.length);
    relatedPosts.push(...otherPosts);
}
---

<Layout title={`${post.data.title} | Blog`}>
  <article class="pt-12 md:pt-20">
    <div class="flex items-center justify-between mb-10">
      <a 
        href="/blog" 
        class="inline-flex items-center gap-2 text-xs uppercase tracking-[0.2em] font-sans text-white hover:text-white transition-colors group"
      >
        <ArrowLeft class="w-4 h-4 group-hover:-translate-x-1 transition-transform" />
        BACK TO BLOG
      </a>
      
      <button 
        id="share-button"
        class="inline-flex items-center gap-2 text-sm font-sans text-neutral-500 hover:text-white transition-colors cursor-pointer group"
      >
        <Share2 class="w-5 h-5 group-hover:scale-110 transition-transform" />
      </button>
    </div>

    {post.data.heroImage && (
      <div class="relative aspect-video w-full overflow-hidden rounded-2xl bg-neutral-900 border border-white/5 mb-16">
        <img 
          src={post.data.heroImage} 
          alt={post.data.title}
          class="object-cover w-full h-full"
        />
      </div>
    )}

    <header class="space-y-6 mb-16">
      <h1 class="text-3xl md:text-5xl font-serif italic text-white leading-tight">
        {post.data.title}
      </h1>

      <div class="flex flex-wrap items-center gap-6 text-neutral-500 font-sans text-sm">
        <div class="flex items-center gap-2">
          <Calendar class="w-4 h-4" />
          {post.data.date}
        </div>
        <div class="flex items-center gap-2">
          <Clock class="w-4 h-4" />
          {readingTime}
        </div>
      </div>
    </header>

    <div class="prose prose-invert prose-neutral max-w-none mb-24">
        <div class="space-y-8 text-neutral-300 font-sans text-base md:text-lg leading-relaxed">
            <Content />
        </div>
    </div>

    {relatedPosts.length > 0 && (
      <section class="border-t border-white/10 pt-16 mb-20">
        <h3 class="text-xs uppercase tracking-[0.2em] font-sans text-neutral-500 mb-10">
          Continue Reading
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          {relatedPosts.map((relatedPost) => (
            <a 
              href={`/blog/${relatedPost.slug}`}
              class="group block space-y-4"
            >
              <div class="relative aspect-video overflow-hidden rounded-xl bg-neutral-900 border border-white/5">
                <img 
                  src={relatedPost.data.heroImage} 
                  alt={relatedPost.data.title}
                  class="object-cover w-full h-full group-hover:scale-105 transition-transform duration-500"
                />
              </div>
              <div class="space-y-2">
                <h4 class="text-xl font-serif italic text-white group-hover:text-neutral-300 transition-colors">
                  {relatedPost.data.title}
                </h4>
                <p class="text-sm text-neutral-500 font-sans">
                  {relatedPost.data.date} Â· {relatedPost.data.category}
                </p>
              </div>
            </a>
          ))}
        </div>
      </section>
    )}
  </article>
</Layout>

<script>
    document.addEventListener('astro:page-load', () => {
        const shareButton = document.getElementById('share-button');
        
        if (shareButton) {
            shareButton.addEventListener('click', async () => {
                try {
                    await navigator.share({
                        title: document.title,
                        url: window.location.href
                    });
                } catch (err) {
                    try {
                        await navigator.clipboard.writeText(window.location.href);
                        const originalText = shareButton.innerHTML;
                        shareButton.innerHTML = 'Copied!';
                        setTimeout(() => {
                            shareButton.innerHTML = originalText;
                        }, 2000);
                    } catch (copyErr) {
                        console.error('Failed to share:', err);
                    }
                }
            });
        }
    });
</script>

<style is:global>
    .prose h2 {
        font-family: ui-serif, Georgia, Cambria, "Times New Roman", Times, serif;
        font-style: italic;
        color: white;
        font-size: 1.5rem;
        margin-top: 2.5rem;
        margin-bottom: 1.25rem;
    }
    .prose p {
        margin-bottom: 1.5rem;
    }
    .prose blockquote {
        background: rgb(23 23 23);
        border: 1px solid rgba(255, 255, 255, 0.05);
        padding: 2rem;
        border-radius: 1rem;
        font-family: ui-serif, Georgia, Cambria, "Times New Roman", Times, serif;
        font-style: italic;
        color: rgba(255, 255, 255, 0.8);
        margin: 3rem 0;
    }
    .prose ul {
        list-style-type: disc;
        padding-left: 1.25rem;
        color: rgb(163 163 163);
        margin-bottom: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
</style>
